<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f6f6f6;
    }
    h2 {
      margin-bottom: 5px;
    }
    #error {
      color: red;
      font-weight: bold;
      margin-top: 20px;
    }
    canvas {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
    }
  </style>
</head>

<body>

<h2>Historial Trimestral</h2>
<p id="subtitulo"></p>

<canvas id="grafico" height="120"></canvas>

<div id="error"></div>

<script>
/* ===============================
   1. LEER PARÁMETROS URL
================================ */
const params = new URLSearchParams(window.location.search);

const cliente  = params.get("cliente");
const anio     = params.get("anio");
const servicio = params.get("servicio");
const periodo  = params.get("periodo");

if (!cliente || !anio || !servicio || !periodo) {
  document.getElementById("error").innerText =
    "Faltan parámetros en la URL.";
  throw new Error("Parámetros incompletos");
}

document.getElementById("subtitulo").innerText =
  `${cliente} · ${servicio} · ${anio} · ${periodo}`;

/* ===============================
   2. LLAMAR API
================================ */
const API_URL = "https://script.google.com/macros/s/AKfycbwFm-T83T1uVn-KvEhOfxY51tGMR5HZLprOV42D04v64Nidp-fIq7EPY01uD13rlkKAag/exec";

async function cargar() {
  const url =
    `${API_URL}?action=historial` +
    `&cliente=${encodeURIComponent(cliente)}` +
    `&año=${encodeURIComponent(anio)}` +
    `&servicio=${encodeURIComponent(servicio)}` +
    `&periodo=${encodeURIComponent(periodo)}`;

  const res = await fetch(url);
  const data = await res.json();

  console.log("Respuesta API:", data);

  if (!data.historial || data.historial.length === 0) {
    document.getElementById("error").innerText =
      "No hay datos de historial para los filtros seleccionados.";
    return;
  }

  renderGrafico(data.historial);
}

/* ===============================
   3. GRAFICO
================================ */
function renderGrafico(historial) {

  const labels = historial.map(h => h.periodo);
  const valores = historial.map(h => h.promedio);

  new Chart(document.getElementById("grafico"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Promedio trimestral",
        data: valores,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

cargar();
</script>

</body>
</html>
