<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Tarifas</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1115;
  color: #fff;
  padding: 30px;
}

h1 { margin-bottom: 5px; }
.subtitulo { color: #aaa; margin-bottom: 25px; }

.kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.kpi {
  background: #1a1d24;
  padding: 20px;
  border-radius: 12px;
}
.kpi small { color: #aaa; }
.kpi h2 { margin: 10px 0 0; font-size: 26px; }

.graficos {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.grafico {
  background: #1a1d24;
  padding: 20px;
  border-radius: 12px;
}
</style>
</head>

<body>

<h1 style="color:#ff7a18">ðŸ“Š Dashboard Ejecutivo</h1>
<div class="subtitulo" id="detalle"></div>

<div class="kpis" id="kpis"></div>

<div class="graficos">
  <div class="grafico">
    <h3>Promedio trimestral</h3>
    <canvas id="graficoPromedios"></canvas>
  </div>
  <div class="grafico">
    <h3>VariaciÃ³n trimestral (%)</h3>
    <canvas id="graficoVariacion"></canvas>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw9ugA1sV5nywFHIFcekwi3vx_ziGuQX5CLBcX7k5ew93eJx-6ICVnxELJuwnwGphHuqA/exec";

// =====================
// PARÃMETROS (CLAVE)
// =====================
const params = new URLSearchParams(window.location.search);
const cliente  = params.get("cliente");
const anio     = params.get("anio");     // â† SIN Ã‘
const servicio = params.get("servicio");
const periodo  = params.get("periodo");  // trimestral

if (!cliente || !anio || !servicio || !periodo) {
  alert("Faltan parÃ¡metros");
  throw new Error("ParÃ¡metros incompletos");
}

document.getElementById("detalle").textContent =
  `Cliente: ${cliente} | AÃ±o: ${anio} | Servicio: ${servicio}`;

// =====================
// CARGA
// =====================
cargarDashboard();

async function cargarDashboard() {

  const url =
    `${API_URL}?action=historial` +
    `&cliente=${encodeURIComponent(cliente)}` +
    `&anio=${encodeURIComponent(anio)}` +
    `&servicio=${encodeURIComponent(servicio)}` +
    `&periodo=${encodeURIComponent(periodo)}`;

  const res = await fetch(url);
  const data = await res.json();

  console.log("RESPUESTA API:", data);

  if (!data.historial || data.historial.length === 0) {
    alert("No hay datos de historial");
    return;
  }

  const historial = calcularVariacion(data.historial);

  renderKPIs(historial);
  renderGraficos(historial);
}

// =====================
// VARIACIÃ“N
// =====================
function calcularVariacion(arr) {
  return arr.map((d, i) => {
    if (i === 0) return { ...d, variacion: 0 };
    const prev = arr[i - 1].promedio;
    const v = ((d.promedio - prev) / prev) * 100;
    return { ...d, variacion: Number(v.toFixed(2)) };
  });
}

// =====================
// KPIS
// =====================
function renderKPIs(data) {

  const promedio =
    data.reduce((a,b)=>a+b.promedio,0) / data.length;

  const ultimaVar = data.at(-1).variacion;

  document.getElementById("kpis").innerHTML = `
    <div class="kpi">
      <small>Promedio trimestral</small>
      <h2>$ ${Math.round(promedio).toLocaleString("es-AR")}</h2>
    </div>

    <div class="kpi">
      <small>VariaciÃ³n Ãºltimo trimestre</small>
      <h2>${ultimaVar > 0 ? "+" : ""}${ultimaVar} %</h2>
    </div>

    <div class="kpi">
      <small>Trimestres analizados</small>
      <h2>${data.length}</h2>
    </div>
  `;
}

// =====================
// GRÃFICOS
// =====================
function renderGraficos(data) {

  const labels = data.map(d => d.periodo);

  new Chart(graficoPromedios, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Promedio",
        data: data.map(d => d.promedio),
        backgroundColor: "#f0822d"
      }]
    }
  });

  new Chart(graficoVariacion, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "% VariaciÃ³n",
        data: data.map(d => d.variacion),
        borderColor: "#4bc0c0",
        tension: 0.3
      }]
    }
  });
}
</script>

</body>
</html>
