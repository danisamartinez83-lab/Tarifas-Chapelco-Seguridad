<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Ejecutivo</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1115;
  color: #fff;
  margin: 0;
  padding: 30px;
}

h1 {
  color: #ff7a18;
  margin-bottom: 5px;
}

.subtitulo {
  color: #aaa;
  margin-bottom: 25px;
}

/* KPIs */
.kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.kpi {
  background: #1a1d24;
  padding: 20px;
  border-radius: 14px;
  border-left: 6px solid #ff7a18;
}

.kpi small {
  color: #aaa;
  font-size: 13px;
}

.kpi h2 {
  margin: 8px 0 0;
  font-size: 26px;
  color: #ffb26b;
}

/* Gr谩fico */
.grafico {
  background: #1a1d24;
  padding: 25px;
  border-radius: 14px;
}
/* ==========================
   COLORES KPI DECISIN
========================== */

.kpi {
  background: #1a1d24;
  padding: 18px;
  border-radius: 12px;
  border-left: 6px solid #444;
}

.kpi h2 {
  margin: 8px 0 0;
  color: #ff7a18;
}

.kpi small {
  color: #aaa;
}

.kpi.verde {
  border-left-color: #4caf50;
}

.kpi.amarillo {
  border-left-color: #ff9800;
}

.kpi.rojo {
  border-left-color: #f44336;
}
</style>
</head>

<body>

<h1> Dashboard Ejecutivo</h1>
<div class="subtitulo" id="detalle"></div>

<div class="kpis" id="kpis"></div>

<div class="grafico">
  <h3 style="color:#ff7a18;margin:0">Tarifa vs Inflaci贸n</h3>
  <canvas id="grafico" height="120"></canvas>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const cliente  = params.get("cliente");
const anio     = params.get("anio");
const servicio = params.get("servicio");
const periodo  = params.get("periodo");

document.getElementById("detalle").innerText =
  `${cliente} 路 ${servicio} 路 ${anio} 路 ${periodo}`;

const API =
"https://script.google.com/macros/s/AKfycbwFm-T83T1uVn-KvEhOfxY51tGMR5HZLprOV42D04v64Nidp-fIq7EPY01uD13rlkKAag/exec";

let chart;

async function cargar() {

  const [histRes, inflRes] = await Promise.all([
    fetch(`${API}?action=historial&cliente=${cliente}&a帽o=${anio}&servicio=${servicio}&periodo=${periodo}`).then(r=>r.json()),
    fetch(`${API}?action=inflacion_trimestral&anio=${anio}`).then(r=>r.json())
  ]);

  const historial = histRes.historial;
  const inflacion = inflRes.inflacion;

  if (!historial || historial.length === 0) {
    alert("No hay historial");
    return;
  }

 const mapaInflacion = {};
inflacion.forEach(i => mapaInflacion[i.periodo] = i.inflacion);

historial.forEach(h => {

  const variacionPct =
    Math.abs(h.variacion) < 1 ? h.variacion * 100 : h.variacion;

  const inflacionPct =
    Math.abs(mapaInflacion[h.periodo]) < 1
      ? mapaInflacion[h.periodo] * 100
      : mapaInflacion[h.periodo];

  h.variacion = Number(variacionPct.toFixed(2));
  h.inflacion = Number(inflacionPct.toFixed(2));
  h.brecha = Number((h.variacion - h.inflacion).toFixed(2));
});

  renderKPIs(historial);
  renderGrafico(historial);
}
function estadoBrecha(brecha) {
  if (brecha >= 1.5) return "verde";
  if (brecha <= -1.5) return "rojo";
  return "amarillo";
}

function renderKPIs(hist) {

  const ultimo = hist.at(-1);
const color = estadoBrecha(ultimo.brecha);

  document.getElementById("kpis").innerHTML = `
    <div class="kpi">
      <small>Tarifa actual</small>
      <h2>$ ${Math.round(ultimo.promedio).toLocaleString("es-AR")}</h2>
    </div>

    <div class="kpi">
      <small>Variaci贸n 煤ltimo trimestre</small>
      <h2>${ultimo.variacion}%</h2>
    </div>

    <div class="kpi">
      <small>Inflaci贸n 煤ltimo trimestre</small>
      <h2>${ultimo.inflacion}%</h2>
    </div>

    
    <div class="kpi ${color}">
  <small>Brecha vs inflaci贸n</small>
  <h2>${ultimo.brecha > 0 ? "+" : ""}${ultimo.brecha}%</h2>
</div>

  `;
}

function renderGrafico(hist) {

  const labels = hist.map(h => h.periodo);

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("grafico"), {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Variaci贸n tarifa %",
          data: hist.map(h => h.variacion),
          borderColor: "#ff7a18",
          tension: 0.35
        },
        {
          label: "Inflaci贸n %",
          data: hist.map(h => h.inflacion),
          borderColor: "#4bc0c0",
          borderDash: [6,6],
          tension: 0.35
        }
      ]
    },
    options: {
      plugins: {
        legend: { labels: { color: "#fff" } }
      },
      scales: {
        x: { ticks: { color: "#aaa" } },
        y: { ticks: { color: "#aaa" } }
      }
    }
  });
}

cargar();
</script>

</body>
</html>
