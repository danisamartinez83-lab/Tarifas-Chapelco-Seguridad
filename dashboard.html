<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Ejecutivo</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ====== TEMA OSCURO ====== */
body {
  font-family: Arial, sans-serif;
  background: #0f1115;
  color: #ffffff;
  margin: 0;
  padding: 30px;
}

h1 {
  margin: 0;
  color: #ff7a18;
}

.subtitulo {
  color: #aaa;
  margin-bottom: 25px;
}

/* ====== KPIs ====== */
.kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.kpi {
  background: #1a1d24;
  padding: 20px;
  border-radius: 14px;
  border-left: 6px solid #ff7a18;
}

.kpi small {
  color: #aaa;
  font-size: 13px;
}

.kpi h2 {
  margin: 8px 0 0;
  font-size: 26px;
  color: #ffb26b;
}

/* ====== GRAFICO ====== */
.grafico {
  background: #1a1d24;
  padding: 25px;
  border-radius: 14px;
}

canvas {
  margin-top: 10px;
}
</style>
</head>

<body>

<h1> Dashboard Ejecutivo</h1>
<div class="subtitulo" id="detalle"></div>

<div class="kpis" id="kpis"></div>

<div class="grafico">
  <h3 style="margin:0;color:#ff7a18;">Evoluci贸n trimestral de tarifa</h3>
  <canvas id="graficoTarifa" height="120"></canvas>
</div>

<script>
/* ===============================
   PARAMETROS
================================ */
const params = new URLSearchParams(window.location.search);
const cliente  = params.get("cliente");
const anio     = params.get("anio");
const servicio = params.get("servicio");
const periodo  = params.get("periodo");

if (!cliente || !anio || !servicio || !periodo) {
  alert("Faltan par谩metros para el dashboard");
}

document.getElementById("detalle").innerText =
  `${cliente} 路 ${servicio} 路 ${anio} 路 ${periodo}`;

/* ===============================
   API
================================ */
const API_URL =
"https://script.google.com/macros/s/AKfycbwFm-T83T1uVn-KvEhOfxY51tGMR5HZLprOV42D04v64Nidp-fIq7EPY01uD13rlkKAag/exec";

let chart;

/* ===============================
   CARGA
================================ */
async function cargar() {

  const url =
    `${API_URL}?action=historial` +
    `&cliente=${encodeURIComponent(cliente)}` +
    `&a帽o=${encodeURIComponent(anio)}` +
    `&servicio=${encodeURIComponent(servicio)}` +
    `&periodo=${encodeURIComponent(periodo)}`;

  const res = await fetch(url);
  const data = await res.json();

  if (!data.historial || data.historial.length === 0) {
    alert("No hay datos de historial");
    return;
  }

  renderKPIs(data.historial);
  renderGrafico(data.historial);
}

/* ===============================
   KPIs
================================ */
function renderKPIs(historial) {

  const ultimo = historial[historial.length - 1];

  const tarifaActual = ultimo.promedio;
  const variacionUlt = ultimo.variacion;

  const variacionAcum =
    ((ultimo.promedio - historial[0].promedio) /
      historial[0].promedio) * 100;

  document.getElementById("kpis").innerHTML = `
    <div class="kpi">
      <small>Tarifa actual</small>
      <h2>$ ${Math.round(tarifaActual).toLocaleString("es-AR")}</h2>
    </div>

    <div class="kpi">
      <small>Variaci贸n 煤ltimo trimestre</small>
      <h2>${variacionUlt > 0 ? "+" : ""}${variacionUlt} %</h2>
    </div>

    <div class="kpi">
      <small>Variaci贸n acumulada</small>
      <h2>${variacionAcum.toFixed(2)} %</h2>
    </div>

    <div class="kpi">
      <small>Trimestres analizados</small>
      <h2>${historial.length}</h2>
    </div>
  `;
}

/* ===============================
   GRAFICO
================================ */
function renderGrafico(historial) {

  const labels = historial.map(h => h.periodo);
  const valores = historial.map(h => h.promedio);

  if (chart) chart.destroy();

  chart = new Chart(
    document.getElementById("graficoTarifa"),
    {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Tarifa promedio",
          data: valores,
          borderColor: "#ff7a18",
          backgroundColor: "rgba(255,122,24,0.15)",
          tension: 0.35,
          fill: true
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: "#fff" } }
        },
        scales: {
          x: { ticks: { color: "#aaa" } },
          y: { ticks: { color: "#aaa" } }
        }
      }
    }
  );
}

cargar();
</script>

</body>
</html>
