<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Tarifas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1115;
  color: #fff;
  margin: 0;
  padding: 30px;
}

h1 {
  margin-bottom: 5px;
}

.subtitulo {
  color: #aaa;
  margin-bottom: 25px;
}

.kpis {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
}

.kpi {
  flex: 1;
  background: #1a1d24;
  padding: 20px;
  border-radius: 10px;
}

.kpi small {
  color: #aaa;
}

.kpi h2 {
  margin: 10px 0 0;
  font-size: 26px;
}

.graficos {
  display: flex;
  gap: 20px;
}

.grafico {
  flex: 1;
  background: #1a1d24;
  padding: 20px;
  border-radius: 10px;
}

.acciones {
  margin-top: 30px;
}

button {
  background: #f0822d;
  border: none;
  color: #000;
  padding: 10px 18px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  margin-right: 10px;
}

button.sec {
  background: #444;
  color: #fff;
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard de Tarifas</h1>
<div class="subtitulo" id="detalle"></div>

<div class="kpis">
  <div class="kpi">
    <small>Promedio perÃ­odo</small>
    <h2 id="kpiPromedio">â€”</h2>
  </div>
  <div class="kpi">
    <small>% VariaciÃ³n</small>
    <h2 id="kpiVariacion">â€”</h2>
  </div>
</div>

<div class="graficos">
  <div class="grafico">
    <canvas id="graficoPromedios"></canvas>
  </div>
  <div class="grafico">
    <canvas id="graficoVariacion"></canvas>
  </div>
</div>

<div class="acciones">
  <button onclick="window.location.href='index.html'">â¬… Volver</button>
  <button class="sec" onclick="limpiarDashboard()">Limpiar</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw9ugA1sV5nywFHIFcekwi3vx_ziGuQX5CLBcX7k5ew93eJx-6ICVnxELJuwnwGphHuqA/exec";

let chartPromedios = null;
let chartVariacion = null;

const params = new URLSearchParams(window.location.search);
const cliente = params.get("cliente");
const anio = params.get("aÃ±o");
const servicio = params.get("servicio");
const periodo = params.get("periodo");

if (!cliente || !anio || !servicio || !periodo) {
  alert("Faltan parÃ¡metros para el dashboard");
}

document.getElementById("detalle").textContent =
  `Cliente: ${cliente} | AÃ±o: ${anio} | Servicio: ${servicio} | PerÃ­odo: ${periodo}`;

cargarDashboard();

function cargarDashboard() {
  fetch(`${API_URL}?action=historial&cliente=${cliente}&aÃ±o=${anio}&servicio=${servicio}&periodo=${periodo}`)
    .then(r => r.json())
    .then(data => {
      if (!data || data.length === 0) {
        alert("No hay datos para mostrar");
        return;
      }
      renderKPIs(data);
      renderGraficos(data);
    });
}

function renderKPIs(data) {
  const avg = data.reduce((a,b)=>a + Number(b.promedio), 0) / data.length;
  document.getElementById("kpiPromedio").textContent =
    "$ " + Math.round(avg).toLocaleString("es-AR");

  document.getElementById("kpiVariacion").textContent =
    data[data.length - 1].variacion + " %";
}

function renderGraficos(data) {
  if (chartPromedios) chartPromedios.destroy();
  if (chartVariacion) chartVariacion.destroy();

  const labels = data.map(d => d.periodo);

  chartPromedios = new Chart(document.getElementById("graficoPromedios"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Promedio",
        data: data.map(d => d.promedio),
        backgroundColor: "#f0822d"
      }]
    }
  });

  chartVariacion = new Chart(document.getElementById("graficoVariacion"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "% VariaciÃ³n",
        data: data.map(d => d.variacion),
        borderColor: "#4bc0c0"
      }]
    }
  });
}

function limpiarDashboard() {
  document.getElementById("kpiPromedio").textContent = "â€”";
  document.getElementById("kpiVariacion").textContent = "â€”";
  if (chartPromedios) chartPromedios.destroy();
  if (chartVariacion) chartVariacion.destroy();
}
</script>

</body>
</html>


