<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Tarifas</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1115;
  color: #fff;
  margin: 0;
  padding: 30px;
}

h1 { margin-bottom: 5px; }
.subtitulo { color: #aaa; margin-bottom: 25px; }

.kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.kpi {
  background: #1a1d24;
  padding: 20px;
  border-radius: 12px;
}
.kpi small { color: #aaa; }
.kpi h2 { margin: 10px 0 0; font-size: 26px; }

.kpi.verde { border-left: 6px solid #4caf50; }
.kpi.amarillo { border-left: 6px solid #ff9800; }
.kpi.rojo { border-left: 6px solid #f44336; }

.graficos {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.grafico {
  background: #1a1d24;
  padding: 20px;
  border-radius: 12px;
}

button {
  background: #f0822d;
  border: none;
  color: #000;
  padding: 10px 18px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  margin-top: 25px;
}
</style>
</head>

<body>

<h1 style="color:#ff7a18">üìä Dashboard Ejecutivo de Tarifas</h1>
<div class="subtitulo" id="detalle"></div>

<div class="kpis" id="kpis"></div>

<div class="graficos">
  <div class="grafico">
    <h3>Promedio trimestral</h3>
    <canvas id="graficoPromedios"></canvas>
  </div>
  <div class="grafico">
    <h3>Variaci√≥n vs Inflaci√≥n (%)</h3>
    <canvas id="graficoVariacion"></canvas>
  </div>
</div>

<button onclick="window.close()">Cerrar dashboard</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw9ugA1sV5nywFHIFcekwi3vx_ziGuQX5CLBcX7k5ew93eJx-6ICVnxELJuwnwGphHuqA/exec";

let chartPromedios = null;
let chartVariacion = null;

const params = new URLSearchParams(window.location.search);
const cliente = params.get("cliente");
const anio = params.get("a√±o");
const servicio = params.get("servicio");
const periodo = params.get("periodo");

if (!cliente || !anio || !servicio || !periodo) {
  alert("Faltan par√°metros para el dashboard");
}

document.getElementById("detalle").textContent =
  `Cliente: ${cliente} | A√±o: ${anio} | Servicio: ${servicio} | Per√≠odo: ${periodo}`;

async function fetchJSON(url) {
  const r = await fetch(url);
  return await r.json();
}

cargarDashboard();
async function cargarDashboard() {

  const resHist = await fetch(
    `${API_URL}?action=historial&cliente=${cliente}&a√±o=${anio}&servicio=${servicio}&periodo=${periodo}`
  );
  const dataHist = await resHist.json();

  if (!dataHist.historial || dataHist.historial.length === 0) {
    alert("No hay datos de historial");
    return;
  }

  const resInflacion = await fetch(
    `${API_URL}?action=inflacion_trimestral&a√±o=${anio}`
  );
  const dataInflacion = await resInflacion.json();

  const inflacion = dataInflacion.inflacion || [];

  renderKPIs(dataHist.historial, inflacion);
  renderGraficos(dataHist.historial, inflacion);
}


function renderKPIs(data, inflacion = []) {

  const promedioGeneral =
    data.reduce((a,b)=>a + Number(b.promedio), 0) / data.length;

  const variacionActual = data[data.length - 1].variacion;

  let inflacionActual = null;
  if (inflacion.length) {
    inflacionActual = inflacion[inflacion.length - 1].inflacion;
  }

  let brecha = null;
  if (inflacionActual !== null) {
    brecha = Number((variacionActual - inflacionActual).toFixed(2));
  }

  let estado = "verde";
  if (brecha !== null) {
    if (brecha < -2) estado = "rojo";
    else if (brecha < 0) estado = "amarillo";
  }

  document.getElementById("kpis").innerHTML = `
    <div class="kpi">
      <small>Promedio trimestral</small>
      <h2>$ ${Math.round(promedioGeneral).toLocaleString("es-AR")}</h2>
    </div>

    <div class="kpi">
      <small>Variaci√≥n √∫ltimo trimestre</small>
      <h2>${variacionActual > 0 ? "+" : ""}${variacionActual} %</h2>
    </div>

    <div class="kpi ${estado}">
      <small>Brecha vs inflaci√≥n</small>
      <h2>
        ${brecha === null ? "‚Äî" : (brecha > 0 ? "+" : "") + brecha + " %"}
      </h2>
    </div>

    <div class="kpi">
      <small>Trimestres analizados</small>
      <h2>${data.length}</h2>
    </div>
  `;
}
function renderGraficos(data, inflacion = []) {

  const labels = data.map(d => d.periodo);

  if (chartPromedios) chartPromedios.destroy();
  if (chartVariacion) chartVariacion.destroy();

  chartPromedios = new Chart(document.getElementById("graficoPromedios"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Promedio tarifa",
        data: data.map(d => d.promedio),
        backgroundColor: "#f0822d"
      }]
    }
  });

  const datasets = [
    {
      label: "% Variaci√≥n tarifa",
      data: data.map(d => d.variacion),
      borderColor: "#4bc0c0",
      tension: 0.3
    }
  ];

  if (inflacion.length) {
    datasets.push({
      label: "Inflaci√≥n trimestral",
      data: inflacion.map(i => i.inflacion),
      borderColor: "#ff5252",
      borderDash: [5,5],
      tension: 0.3
    });
  }

  chartVariacion = new Chart(document.getElementById("graficoVariacion"), {
    type: "line",
    data: {
      labels,
      datasets
    }
  });
}

</script>

</body>
</html>


