<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tarifario | Chapelco Seguridad Integral</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background-color: #1a1a1a;
  color: #f2f2f2;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}

.header {
  position: fixed;
  top: 3px;
  right: 20px;
  z-index: 1000;
}

.header img {
  width: 180px;
}

.subtitle {
  color: #aaa;
  font-size: 14px;
  margin-top: 60px;
}

.card {
  background: #242424;
  border-radius: 14px;
  padding: 25px;
  margin-top: 25px;
}

.filters {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 15px;
}

select, button {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
}

select {
  background: #222;
  color: #fff;
}

button {
  background: #ff7a18;
  font-weight: bold;
  cursor: pointer;
}

button.secondary {
  background: #444;
  color: #fff;
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 25px;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #333;
}

.graficos {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 25px;
}

.grafico-box {
  background: #1e1e1e;
  border-radius: 14px;
  padding: 15px;
  height: 260px;
}

@media (max-width: 768px) {
  .graficos {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<div class="header">
  <img src="logo.png" alt="Logo Chapelco">
</div>

<div class="container">
<div class="subtitle">Tarifario de Servicios</div>

<div class="card">
  <div class="filters">
    <select id="cliente"></select>
    <select id="anio"></select>
    <select id="mes"></select>
  </div>

  <div class="actions">
    <button onclick="buscar()">Buscar tarifas</button>
    <button class="secondary" onclick="limpiar()">Limpiar</button>
    <button class="secondary" onclick="exportarPDF()">Exportar PDF</button>
    <button class="secondary" onclick="abrirDashboard()">Abrir Dashboard</button>
  </div>

  <table id="tabla" style="display:none">
    <thead>
      <tr>
        <th>Servicio</th>
        <th>Tarifa</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<p style="color:#aaa;margin-top:15px">
  Seleccioná un servicio para ver el historial
</p>

<select id="servicioHistorial">
  <option value="">Seleccionar servicio</option>
</select>

<div class="card">
<h3 style="color:#ff7a18">Historial de Tarifas</h3>

<table id="tablaHistorial" style="display:none">
  <thead>
    <tr>
      <th>Período</th>
      <th>Promedio</th>
      <th>Variación %</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<select id="periodo" onchange="cargarHistorial()">
  <option value="">Seleccionar período</option>
  <option value="anual">Anual</option>
  <option value="semestral">Semestral</option>
  <option value="trimestral">Trimestral</option>
</select>

<div class="graficos">
  <div class="grafico-box">
    <canvas id="graficoHistorial"></canvas>
  </div>
  <div class="grafico-box">
    <canvas id="graficoVariacion"></canvas>
  </div>
</div>
</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbycd0FX9iIXBhgBH37GdauiA9j69RR9aXLkJUgZyC_f926vXcIcGBIajX--btDXPjLn2A/exec";

const clienteEl = () => document.getElementById("cliente");
const anioEl = () => document.getElementById("anio");
const mesEl = () => document.getElementById("mes");

let chartPromedio = null;
let chartVariacion = null;

async function cargarFiltros() {
  const res = await fetch(API + "?action=distinct");
  const d = await res.json();

  fill(clienteEl(), d.clientes);
  fill(anioEl(), d.años);
 fill(mesEl(), d.meses.map(Number).sort((a,b)=>a-b)); 
}

function fill(select, arr) {
  select.innerHTML = `<option value="">Seleccionar</option>`;
  arr.forEach(v => {
    select.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

async function buscar() {
  const url = `${API}?action=search&cliente=${clienteEl().value}&año=${anioEl().value}&mes=${mesEl().value}`;
  const res = await fetch(url);
  const data = await res.json();

  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  const serviciosSet = new Set();

  data.results.forEach(r => {
    serviciosSet.add(r.servicio);
    tbody.innerHTML += `
      <tr>
        <td>${r.servicio}</td>
        <td>$ ${Number(r.tarifa).toLocaleString("es-AR")}</td>
      </tr>`;
  });

  document.getElementById("tabla").style.display = "table";

  const sel = document.getElementById("servicioHistorial");
  sel.innerHTML = `<option value="">Seleccionar servicio</option>`;
  [...serviciosSet].forEach(s => {
    sel.innerHTML += `<option value="${s}">${s}</option>`;
  });
}

function limpiar() {

  // filtros principales
  clienteEl().value = "";
  anioEl().value = "";
  mesEl().value = "";

  // tabla principal
  document.getElementById("tabla").style.display = "none";

  // selector de servicio historial
  const serv = document.getElementById("servicioHistorial");
  if (serv) serv.innerHTML = `<option value="">Seleccionar servicio</option>`;

  // período
  const periodo = document.getElementById("periodo");
  if (periodo) periodo.value = "";

  // tabla historial
  const tablaHist = document.getElementById("tablaHistorial");
  if (tablaHist) tablaHist.style.display = "none";

  // destruir gráficos
  if (typeof chartPromedio !== "undefined" && chartPromedio) {
    chartPromedio.destroy();
    chartPromedio = null;
  }

  if (typeof chartVariacion !== "undefined" && chartVariacion) {
    chartVariacion.destroy();
    chartVariacion = null;
  }

  // limpiar canvas (por las dudas)
  const c1 = document.getElementById("graficoHistorial");
  const c2 = document.getElementById("graficoVariacion");

  if (c1) c1.getContext("2d").clearRect(0,0,c1.width,c1.height);
  if (c2) c2.getContext("2d").clearRect(0,0,c2.width,c2.height);
}


async function cargarHistorial() {
  const periodo = document.getElementById("periodo").value;
  const cliente = clienteEl().value;
  const año = anioEl().value;
  const servicio = document.getElementById("servicioHistorial").value;

  if (!cliente || !año || !servicio || !periodo) {
    console.log("Faltan filtros", { cliente, año, servicio, periodo });
    return;
  }

  const url = `${API}?action=historial&cliente=${cliente}&año=${año}&servicio=${servicio}&periodo=${periodo}`;
  console.log("Consultando:", url);

  const res = await fetch(url);
  const { historial } = await res.json();

  if (!historial || !historial.length) {
    console.warn("Historial vacío");
    return;
  }

  const tbody = document.querySelector("#tablaHistorial tbody");
  tbody.innerHTML = "";

  historial.forEach(h => {
    tbody.innerHTML += `
      <tr>
        <td>${h.periodo}</td>
        <td>$ ${h.promedio.toLocaleString("es-AR")}</td>
        <td style="color:${h.variacion>=0?'#4caf50':'#f44336'}">
          ${h.variacion>0?'+':''}${h.variacion} %
        </td>
      </tr>`;
  });

  document.getElementById("tablaHistorial").style.display = "table";
  renderGraficos(historial);
}


function renderGraficos(historial) {
  const labels = historial.map(h => h.periodo);

  if (chartPromedio) chartPromedio.destroy();
  chartPromedio = new Chart(graficoHistorial, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Promedio de tarifa",
        data: historial.map(h => h.promedio),
        borderColor: "#ff7a18",
        backgroundColor: "rgba(255,122,24,0.2)",
        fill: true
      }]
    }
  });

  if (chartVariacion) chartVariacion.destroy();
  chartVariacion = new Chart(graficoVariacion, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Variación %",
        data: historial.map(h => h.variacion),
        backgroundColor: "#4caf50"
      }]
    }
  });
}

function abrirDashboard() {
  const cliente = clienteEl().value;
  const anio = anioEl().value;
  const servicio = document.getElementById("servicioHistorial").value;
  const periodo = document.getElementById("periodo").value;

  if (!cliente || !anio || !servicio || !periodo) {
    alert("Completá cliente, año, servicio y período");
    return;
  }

  const url =
    `dashboard.html?cliente=${encodeURIComponent(cliente)}` +
    `&año=${encodeURIComponent(anio)}` +
    `&servicio=${encodeURIComponent(servicio)}` +
    `&periodo=${encodeURIComponent(periodo)}`;

  window.open(url, "_blank");
}


document.addEventListener("DOMContentLoaded", cargarFiltros);
</script>

</body>
</html>




