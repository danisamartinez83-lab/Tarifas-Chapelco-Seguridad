<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tarifario | Chapelco Seguridad Integral</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background-color: #413e3e;
  color: #f2f2f2;
}


.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
  padding-top: 80px;
}

.header {
  position: fixed;
  top: 10px;
  right: 20px;
  z-index: 9999;
}


.header img {
  width: 150px;
}

.subtitle {
  color: #aaa;
  font-size: 14px;
  margin-top: 60px;
}

.card {
  background: #242424;
  border-radius: 14px;
  padding: 25px;
  margin-top: 25px;
}

.filters {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 15px;
}

select, button {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
}

select {
  background: #222;
  color: #fff;
}

button {
  background: #ff7a18;
  font-weight: bold;
  cursor: pointer;
}

button.secondary {
  background: #444;
  color: #fff;
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 25px;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #333;
}

.graficos {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 25px;
  margin-top: 25px;
}

.grafico-box {
  background: #1e1e1e;
  border-radius: 14px;
  padding: 15px;
  height: 260px;

  display: flex;
  align-items: center;
}
canvas {
  max-width: 100% !important;
  height: 100% !important;
}


@media (max-width: 768px) {
  .graficos {
    grid-template-columns: 1fr;
  }
}
/* Estilos para las Brechas en el Dashboard */
.brechas-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 15px;
}

.kpi-brecha {
  background: #2a2a2a;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  border-bottom: 3px solid #444;
}

.kpi-brecha.verde { border-color: #4caf50; }
.kpi-brecha.rojo { border-color: #f44336; }

.kpi-brecha h4 {
  margin: 0;
  font-size: 12px;
  color: #aaa;
  text-transform: uppercase;
}


#kpis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.kpi h2 {
    font-size: 24px;
    margin: 5px 0;
}

.kpi.verde { border-left: 5px solid #4caf50; background: #1b2e1b; }
.kpi.rojo { border-left: 5px solid #f44336; background: #2e1b1b; }
.kpi.amarillo { border-left: 5px solid #ff7a18; background: #2e261b; }
/* Asegura que el contenedor de brechas use el mismo dise침o de cuadr칤cula que los KPIs de arriba */
#brechas-detalle {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

/* Altura aumentada para los gr치ficos */
.chart-container {
    position: relative;
    height: 450px; /* Ajuste de altura para que se vea imponente */
    width: 100%;
    margin: 20px 0;
}



</style>
</head>

<body>

<div class="header">
  <img src="logo.png" alt="Logo Chapelco">
</div>

<div class="container">
<div class="subtitle">Tarifario de Servicios</div>

<div class="card">
  <div class="filters">
    <select id="cliente"></select>
    <select id="anio"></select>
    <select id="mes"></select>
  </div>

<div class="actions">
    <button onclick="buscar()">游댌 Buscar tarifas</button>
    <button class="secondary" onclick="limpiar()">Limpiar</button>
    <button class="secondary" onclick="exportarPDF()">Exportar PDF</button>
    <button class="secondary" onclick="abrirDashboard()">Abrir Dashboard</button>
    
    <button id="btnExportarMasivo" class="secondary" style="background-color: #3d4449; color: #fff; border: 1px solid #555;">
        游닌 Reporte Mensual (Todos)
    </button>
</div>
</div>
  <table id="tabla" style="display:none">
    <thead>
      <tr>
        <th>Servicio</th>
        <th>Tarifa</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<p style="color:#aaa;margin-top:15px">
  Seleccion치 un servicio para ver el historial
</p>

<select id="servicioHistorial">
  <option value="">Seleccionar servicio</option>
</select>

<div class="card">
<h3 style="color:#ff7a18">Historial de Tarifas</h3>

<table id="tablaHistorial" style="display:none">
  <thead>
    <tr>
      <th>Per칤odo</th>
      <th>Promedio</th>
      <th>Variaci칩n %</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<select id="periodo" onchange="cargarHistorial()">
  <option value="">Seleccionar per칤odo</option>
  <option value="anual">Anual</option>
  <option value="semestral">Semestral</option>
  <option value="trimestral">Trimestral</option>
</select>

<div class="graficos">
  <div class="grafico-box">
    <canvas id="graficoHistorial"></canvas>
  </div>
  <div class="grafico-box">
    <canvas id="graficoVariacion"></canvas>
  </div>
</div>
</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzbJXAFOLJn6-PL2-i2TKCz1czgJCtokr8nMHGWGTBY1R3wFjJqNCr4x_C0Iatb0gglsQ/exec";

const clienteEl = () => document.getElementById("cliente");
const anioEl = () => document.getElementById("anio");
const mesEl = () => document.getElementById("mes");

let chartPromedio = null;
let chartVariacion = null;

async function cargarFiltros() {
  const res = await fetch(API + "?action=distinct");
  const d = await res.json();

  fill(clienteEl(), d.clientes);
  fill(anioEl(), d.a침os);
 fill(mesEl(), d.meses.map(Number).sort((a,b)=>a-b)); 
}

function fill(select, arr) {
  select.innerHTML = `<option value="">Seleccionar</option>`;
  arr.forEach(v => {
    select.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

async function buscar() {
  const url = `${API}?action=search&cliente=${clienteEl().value}&a침o=${anioEl().value}&mes=${mesEl().value}`;
  const res = await fetch(url);
  const data = await res.json();

  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  const serviciosSet = new Set();

  data.results.forEach(r => {
    serviciosSet.add(r.servicio);
    tbody.innerHTML += `
      <tr>
        <td>${r.servicio}</td>
        <td>$ ${Number(r.tarifa).toLocaleString("es-AR")}</td>
      </tr>`;
  });

  document.getElementById("tabla").style.display = "table";

  const sel = document.getElementById("servicioHistorial");
  sel.innerHTML = `<option value="">Seleccionar servicio</option>`;
  [...serviciosSet].forEach(s => {
    sel.innerHTML += `<option value="${s}">${s}</option>`;
  });
}

function limpiar() {

  // filtros principales
  clienteEl().value = "";
  anioEl().value = "";
  mesEl().value = "";

  // tabla principal
  document.getElementById("tabla").style.display = "none";

  // selector de servicio historial
  const serv = document.getElementById("servicioHistorial");
  if (serv) serv.innerHTML = `<option value="">Seleccionar servicio</option>`;

  // per칤odo
  const periodo = document.getElementById("periodo");
  if (periodo) periodo.value = "";

  // tabla historial
  const tablaHist = document.getElementById("tablaHistorial");
  if (tablaHist) tablaHist.style.display = "none";

  // destruir gr치ficos
  if (typeof chartPromedio !== "undefined" && chartPromedio) {
    chartPromedio.destroy();
    chartPromedio = null;
  }

  if (typeof chartVariacion !== "undefined" && chartVariacion) {
    chartVariacion.destroy();
    chartVariacion = null;
  }

  // limpiar canvas (por las dudas)
  const c1 = document.getElementById("graficoHistorial");
  const c2 = document.getElementById("graficoVariacion");

  if (c1) c1.getContext("2d").clearRect(0,0,c1.width,c1.height);
  if (c2) c2.getContext("2d").clearRect(0,0,c2.width,c2.height);
}

async function cargarHistorial() {
  const periodo = document.getElementById("periodo").value;
  const cliente = clienteEl().value;
  const a침o = anioEl().value;
  const servicio = document.getElementById("servicioHistorial").value;

  if (!cliente || !a침o || !servicio || !periodo) {
    alert("Faltan seleccionar filtros para el historial");
    return;
  }

  const url = `${API}?action=historial&cliente=${cliente}&a침o=${a침o}&servicio=${servicio}&periodo=${periodo}`;
  
  try {
    const res = await fetch(url);
    const { historial } = await res.json();

    if (!historial || !historial.length) {
      alert("No se encontraron datos para este historial");
      return;
    }

    const tbody = document.querySelector("#tablaHistorial tbody");
    tbody.innerHTML = "";

    historial.forEach((h, index) => {
      // Si es el primer elemento y es 0%, pero sabemos que es Enero, 
      // dejamos una nota visual o el valor que traiga la API
      let variacionLimpia = (h.variacion === null || h.variacion === undefined) ? 0 : h.variacion;
      
      const colorTexto = variacionLimpia > 0 ? '#4caf50' : (variacionLimpia < 0 ? '#f44336' : '#aaa');
      const signo = variacionLimpia > 0 ? '+' : '';

      tbody.innerHTML += `
        <tr>
          <td>${h.periodo}</td>
          <td>$ ${h.promedio.toLocaleString("es-AR")}</td>
          <td style="color:${colorTexto}; font-weight:bold">
            ${variacionLimpia === 0 && index === 0 ? '<small style="color:#888;font-weight:normal">Base</small> 0%' : signo + variacionLimpia + ' %'}
          </td>
        </tr>`;
    });

    document.getElementById("tablaHistorial").style.display = "table";
    renderGraficos(historial);

  } catch (error) {
    console.error("Error al cargar historial:", error);
  }
}


function renderGraficos(historial) {
  const labels = historial.map(h => h.periodo);
if (chartPromedio) chartPromedio.destroy();

chartPromedio = new Chart(graficoHistorial, {
  type: "line",
  data: {
    labels,
    datasets: [{
      label: "Promedio de tarifa",
      data: historial.map(h => h.promedio),
      borderColor: "#ff7a18",
      backgroundColor: "rgba(255,122,24,0.2)",
      fill: true,
      tension: 0.3
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        labels: {
          font: { size: 12 }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          font: { size: 10 }
        }
      },
      y: {
        ticks: {
          font: { size: 10 }
        }
      }
    }
  }
});


 if (chartVariacion) chartVariacion.destroy();

chartVariacion = new Chart(graficoVariacion, {
  type: "bar",
  data: {
    labels,
    datasets: [{
      label: "Variaci칩n %",
      data: historial.map(h => h.variacion),
      backgroundColor: "#4caf50"
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        labels: {
          font: { size: 12 }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          font: { size: 10 }
        }
      },
      y: {
        ticks: {
          font: { size: 10 }
        }
      }
    }
  }
});
}

// Este c칩digo maneja el bot칩n de exportaci칩n masiva
document.getElementById("btnExportarMasivo").onclick = function() {
    const anio = document.getElementById("anio").value; 
    const mes = document.getElementById("mes").value;

    if (!anio || !mes) {
        alert("Por favor, selecciona A침o y Mes");
        return;
    }

    // El par치metro 'authuser=0' suele resolver el conflicto de m칰ltiples cuentas
    const url = `${API}?action=exportar_mensual&a침o=${anio}&mes=${mes}&authuser=0`;
    
    // En m칩viles, para saltar bloqueos, usamos un enlace temporal
    const link = document.createElement('a');
    link.href = url;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    link.click();
};
function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // 1. Obtener datos de los filtros
  const cliente = document.getElementById("cliente").value || "Sin Cliente";
  const servicio = document.getElementById("servicioHistorial").value || "Sin Servicio";
  const anio = document.getElementById("anio").value || "";
  const periodo = document.getElementById("periodo").value || "";

  // 2. Encabezado del Reporte
  doc.setFontSize(20);
  doc.setTextColor(255, 122, 24); // Naranja Chapelco
  doc.text("REPORTE HIST칍RICO DE TARIFAS", 14, 20);
  
  doc.setFontSize(11);
  doc.setTextColor(60, 60, 60);
  doc.text(`Cliente: ${cliente}`, 14, 30);
  doc.text(`Servicio: ${servicio}`, 14, 37);
  doc.text(`A침o de An치lisis: ${anio} | Per칤odo: ${periodo}`, 14, 44);
  
  // L칤nea decorativa naranja
  doc.setDrawColor(255, 122, 24);
  doc.line(14, 48, 196, 48);

  // 3. Generar la Tabla desde el HTML
  doc.autoTable({
    html: '#tablaHistorial',
    startY: 55,
    theme: 'grid',
    headStyles: { 
      fillColor: [255, 122, 24], 
      halign: 'center',
      textColor: [255, 255, 255]
    },
    styles: { fontSize: 10, cellPadding: 3 },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    margin: { left: 14, right: 14 }
  });

  // 4. Agregar Gr치ficos (Si existen y tienen datos)
  const canvasPromedio = document.getElementById("graficoHistorial");
  const canvasVariacion = document.getElementById("graficoVariacion");

  // Si hay gr치ficos, los agregamos en una p치gina nueva
  if (canvasPromedio && canvasVariacion) {
    doc.addPage();
    doc.setFontSize(16);
    doc.setTextColor(255, 122, 24);
    doc.text("AN츼LISIS GR츼FICO", 14, 20);

    // Convertir Gr치fico de Promedio a Imagen
    const imgPromedio = canvasPromedio.toDataURL("image/png");
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text("Evoluci칩n de la Tarifa Promedio:", 14, 30);
    doc.addImage(imgPromedio, 'PNG', 14, 35, 180, 80);

    // Convertir Gr치fico de Variaci칩n a Imagen
    const imgVariacion = canvasVariacion.toDataURL("image/png");
    doc.text("Variaci칩n Porcentual por Per칤odo:", 14, 130);
    doc.addImage(imgVariacion, 'PNG', 14, 135, 180, 80);
  }

  // 5. Pie de p치gina con fecha de emisi칩n
  const fecha = new Date().toLocaleString();
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.text(`Emitido el: ${fecha} - P치gina ${i} de ${pageCount}`, 14, 285);
  }

  // 6. Guardar el archivo
  doc.save(`Reporte_Tarifas_${cliente}_${servicio}.pdf`);
}

  
function abrirDashboard() {
  const cliente = clienteEl().value;
  const anio = anioEl().value;
  const servicio = document.getElementById("servicioHistorial").value;

  if (!cliente || !anio || !servicio) {
    alert("Por favor, seleccion치 Cliente, A침o y un Servicio del historial primero.");
    return;
  }

  // Generamos la URL. El periodo lo manejamos dentro del dashboard.html por defecto.
  const url = `dashboard.html?cliente=${encodeURIComponent(cliente)}&anio=${encodeURIComponent(anio)}&servicio=${encodeURIComponent(servicio)}`;

  window.open(url, "_blank");
}


document.addEventListener("DOMContentLoaded", cargarFiltros);
</script>

</body>
</html>




